<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My To-Do List</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        .overdue { color: red; font-weight: bold; }
        .completed { color: green; text-decoration: line-through; }
    </style>
</head>
<body class="container mt-5">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Welcome, <span th:text="${username}"></span>!</h1>
    <a href="/logout" class="btn btn-danger">Logout</a>
</div>

<div th:if="${notificationCount > 0}" class="alert alert-warning shadow-sm mb-4">
    <h5 class="mb-2">
        <i class="bi bi-bell-fill me-2"></i>
        You have <strong th:text="${notificationCount}"></strong> reminder<span th:text="${notificationCount == 1} ? '' : 's'"></span>
    </h5>
    <ul class="list-group list-group-flush">
        <li class="list-group-item" th:each="notif : ${notifications}">
            <div th:classappend="${#strings.contains(notif.message, 'Tomorrow')} ? 'bg-info text-white p-2 rounded mb-1' : ''">
                <strong th:text="${notif.message}"></strong>
                <small class="d-block mt-1">
                    <i class="bi bi-calendar-event me-1"></i>
                    <span th:text="${#temporals.format(notif.createdAt, 'dd MMM yyyy HH:mm')}"></span>
                    - Task: <span th:text="${notif.task?.title ?: 'Deleted task'}"></span>
                </small>
            </div>
        </li>
    </ul>
</div>

<div th:if="${notificationCount == 0}" class="alert alert-info mb-4">
    <i class="bi bi-bell-slash me-2"></i>No upcoming or overdue tasks right now all good!
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Add New Task</h5>
    </div>
    <div class="card-body">
        <form th:action="@{/tasks}" method="post">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="title" class="form-label">Title *</label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                <div class="col-md-6">
                    <label for="dueDate" class="form-label">Due Date</label>
                    <input type="date" class="form-control" id="dueDate" name="dueDate">
                </div>
                <div class="col-md-4">
                    <label for="priority" class="form-label">Priority</label>
                    <select class="form-select" id="priority" name="priority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="category" class="form-label">Category</label>
                    <input type="text" class="form-control" id="category" name="category" placeholder="e.g. University">
                </div>
                <div class="col-md-4 align-self-end">
                    <button type="submit" class="btn btn-success w-100">Add Task</button>
                </div>
            </div>
        </form>
    </div>
</div>

<h3>Your Tasks</h3>

<div th:if="${tasks == null or #lists.isEmpty(tasks)}" class="alert alert-info">
    No tasks yet. Add your first task above
</div>

<table class="table table-hover table-striped" th:if="${tasks != null and !#lists.isEmpty(tasks)}">
    <thead class="table-dark">
    <tr>
        <th>Title</th>
        <th>Due Date</th>
        <th>Priorty</th>
        <th>Category</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="task : ${tasks}" th:classappend="${task.overdue ? 'table-danger' : ''}">
        <td th:text="${task.title}"></td>
        <td th:text="${task.dueDate}" th:classappend="${task.overdue ? 'overdue' : ''}"></td>
        <td th:text="${task.priority}"></td>
        <td th:text="${task.category} ?: '-'"></td>
        <td th:text="${task.status}" th:classappend="${task.status == 'COMPLETED' ? 'completed' : ''}"></td>
        <td>
            <form th:action="@{/tasks/{id}/complete(id=${task.id})}" method="post">
                <input type="hidden"
                       name="completed"
                       th:value="${task.status != 'COMPLETED'}" />

                <button type="submit" class="btn btn-sm"
                        th:classappend="${task.status == 'COMPLETED'} ? 'btn-success' : 'btn-outline-success'">
                    <span th:text="${task.status == 'COMPLETED'} ? 'Undo' : 'Complete'"></span>
                </button>
            </form>
        </td>
    </tr>
    </tbody>
</table>
</body>
</html>